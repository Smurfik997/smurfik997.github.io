<!DOCTYPE html>
<html lang="uk">
    <head>
        <meta charset="utf-8">
        <meta content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0,shrink-to-fit=no" name="viewport">
        <link rel="stylesheet" href="css/default.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/create-page.css">
        <title lang="en">Sales Slip</title>
    </head>
    <body data-create-page>
        <!-- <div id="preloader">
            <div data-icon></div>
            <div id="preloader-text">Завантаження</div>
        </div> -->
        <header>
            <h1>Create page</h1>
        </header>
        <main>
            <form id="create-form" name="create-form" autocomplete="on">
                <datalist id="shops"></datalist>
                <datalist id="products"></datalist>
                <input type="text" id="shopname" placeholder="Назва закладу" aria-label="Назва закладу" list="shops">
                <input type="date" id="date" aria-label="Дата">
                <table id="main-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Count</th>
                            <th>Units</th>
                            <th>Total Price</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr data-edit oninput="rowChange(this)" onfocusout="rmField(this)">
                            <td>
                                <input type="text" list="products" onfocus="editField(this)" 
                                placeholder="найменування товару" aria-label="найменування товару">
                            </td>
                            <td>
                                <input type="number" step="any" placeholder="кількість" aria-label="кількість">
                            </td>
                            <td>
                                <select aria-label="одиниці вимірювання">
                                    <option lang="en" selected>pcs</option>
                                    <option lang="en">kgs</option>
                                </select>
                            </td>
                            <td>
                                <input type="number" step="any" placeholder="вартість" aria-label="вартість">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="space_container"></div>
                <div class="submit_container">
                    <input type="submit" value="Зберегти">
                </div>
            </form>
        </main>
        <script src="main.js"></script>
        <script>
            ['shop', 'product'].forEach(type => {
                const list = getElement(type + 's')
                const listData = JSON.parse(localStorage.getItem(type + 's'))

                if (!listData) doc.location.href = 'transfer.html'

                listData[type + 's'].forEach(val => {
                    list.innerHTML += `<option value="${val[`${type}-name`]}" data-id="${val.id}"></option>`
                })
            })

            getElement('date').value = new Date().toISOString().substr(0, 10)
            getElement('date').max = new Date().toISOString().substr(0, 10)

            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) 
                document.body.setAttr('data-mobile', '')

            const rowChange = (element) => {
                const inputCollection = getElement('input', 'byTagName', element)
                
                if (inputCollection[0].value && inputCollection[1].value && inputCollection[2].value)
                    if (!element.nextElementSibling) {
                        const currentElement = document.activeElement
                        const tr = addField()
                        const firstInNewRow = getElement('input', 'byTagName', tr)[0]
                        firstInNewRow.focus()
                        firstInNewRow.onfocus = () => editField(firstInNewRow)
                        currentElement.focus()
                    }
            }

            const editField = (element) => {
                const tr = element.parentNode.parentNode

                if (tr.getAttr('data-edit') == null) {
                    const prevEl = document.querySelector('form tr[data-edit]')
                    if (prevEl) prevEl.rmAttr('data-edit')
                    tr.setAttr('data-edit', '')
                    const inputCollection = getElement('input', 'byTagName', tr)
                    inputCollection[2].focus()
                    inputCollection[0].focus()
                }
            }

            const rmField = (element) => {
                const inputCollection = getElement('input', 'byTagName', element)
                
                if (!inputCollection[0].value && !inputCollection[1].value && !inputCollection[2].value)
                    if (element.nextElementSibling)
                        element.remove()
            }

            const addField = (element) => {
                let tr = document.createElement('tr')
                tr.innerHTML = `
                    <td>
                        <input type="text" list="products" placeholder="найменування товару" aria-label="найменування товару"></td>
                    <td><input type="number" step="any" placeholder="кількість" aria-label="кількість"></td><!--
                    --><td><select aria-label="одиниці вимірювання">
                        <option lang="en" selected>pcs</option>
                        <option lang="en">kgs</option>
                    </select></td><!--
                    --><td><input type="number" step="any" placeholder="вартість" aria-label="вартість"></td>
                `
                tr.oninput = () => rowChange(tr)
                tr.addEventListener('focusout', () => rmField(tr))

                getElement('table-body').appendChild(tr)

                return tr
            }
        </script>
    </body>
</html>