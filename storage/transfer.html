<!DOCTYPE html>
<html lang="uk">
    <head>
        <meta charset="utf-8">
        <meta content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0,shrink-to-fit=no" name="viewport">
        <link rel="preload" crossorigin="anonymous" href="fonts/Comfortaa-Cyrillic-Bold.woff2" as="font">
        <link rel="preload" crossorigin="anonymous" href="fonts/Comfortaa-Cyrillic.woff2" as="font">
        <link rel="preload" crossorigin="anonymous" href="fonts/Comfortaa-Latin.woff2" as="font">
        <link rel="dns-prefetch" href="//purchase-history.herokuapp.com/">
        <link rel="stylesheet" href="css/default.css">
        <link rel="icon" href="imgs/icon.png">
        <link rel="apple-touch-icon" href="imgs/apple-icon.png">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/transfer.css">
        <title lang="en">Purchase History - Трансфер</title>
    </head>
    <body>
        <header>
            <h1>Трансфер інформації</h1>
        </header>
        <main data-loading>
            <p id="status">Зв'язок з сервером</p>
            <p>Завантажено: <span id="data-loaded">0</span><span>/2</span></p>
            <p>Надіслано: <span id="data-sended">0</span><span>/</span><span id="data-total">0</span></p>
        </main>
        <script src="main.js"></script>
        <script>
            let data, sendCallback, recordCallback, getListCallback

            if (data = JSON.parse(localStorage.getItem('form-data'))) {
                localStorage.clear()
                const main = getElement('main', 'byTagName')[0]
                const status = getElement('status')
                main.setAttr('data-send', '')
                let apikey
                try {
                    apikey = encodeURIComponent(doc.cookie.split('apikey=')[1].split(';')[0])
                } catch {
                    main.rmAttr('data-loading')
                    main.setAttr('data-error', '')
                    status.innerHTML = 'Невірний код'
                    throw new Error('apikey fault')
                }
                
                const sendedholder = getElement('data-sended')
                const totalholder = getElement('data-total')
                
                let sended = 0
                let total = 0

                const addRecord = () => {
                    status.innerHTML = 'Завершення надсилання'
                    total++
                    totalholder.innerHTML = total

                    if (!parseInt(data['shop-name']))
                        data['shop-name'] = localStorage.getItem(data['shop-name'])

                    let finalData = data['shop-name'] + '_' + data['date']

                    data['products'].forEach(el => {
                        if (!parseInt(el.product))
                            el.product = localStorage.getItem(el.product)

                        finalData += '_' + el.product + '_' + el.count

                        if (el.type == 'kgs')
                            finalData += '_0'
                        else
                            finalData += '_1'
                        
                        finalData += '_' + el.price
                    })

                    localStorage.clear()
                    apiRequest('api/addRecord', {
                        'data': finalData,
                        'apikey': apikey
                    }, 'recordCallback')
                }

                recordCallback = (res) => {
                    if (res.ERR) {
                        main.rmAttr('data-loading')
                        main.setAttr('data-error', '')
                        status.innerHTML = res.ERR.uk
                        return
                    }

                    sended++
                    sendedholder.innerHTML = sended

                    status.innerHTML = 'Збережено'
                    main.rmAttr('data-loading')
                    main.setAttr('data-loaded', '')

                    doc.location.href = 'profile.html'
                }
                
                sendCallback = (res) => {
                    if (main.getAttr('data-error'))
                        return

                    if (res.ERR) {
                        main.rmAttr('data-loading')
                        main.setAttr('data-error', '')
                        status.innerHTML = res.ERR.uk
                        return
                    }

                    sended++
                    sendedholder.innerHTML = sended
                    
                    if (res['callback-data'] == 'shop')
                        localStorage.setItem(res['shop-name'], res.id)
                    else
                        localStorage.setItem(res['product-name'], res.id)

                    if (sended == total)
                        addRecord()
                }

                data.products.forEach((el, index) => {
                    if (!parseInt(el['product'])) {
                        const productName = encodeURIComponent(el['product'])
                        if (getElement('api/addProduct-' + productName))
                            return

                        total++
                        totalholder.innerHTML = total

                        apiRequest('api/addProduct', {
                            'product-name': productName,
                            'apikey': apikey
                        }, 'sendCallback', productName)
                    }
                })

                if (!parseInt(data['shop-name'])) {
                    total++
                    totalholder.innerHTML = total
                    apiRequest('api/addShop', {
                        'shop-name': encodeURIComponent(data['shop-name']),
                        'apikey': apikey
                    }, 'sendCallback', 'shop')
                }

                if (total == 0)
                    addRecord()
            } else {
                localStorage.clear()
                
                class getList {
                    constructor() {
                        this.loaded = 0
                        this.error = false
                        this.status = getElement('status')
                        this.countholder = getElement('data-loaded')
                        this.main = getElement('main', 'byTagName')[0]
                    }

                    callback(type, res) {
                        if (res.ERR) {
                            this.error = true
                            this.status.innerHTML = res.ERR.uk
                            this.main.rmAttr('data-loading')
                            this.main.setAttr('data-error', '')
                        } else if (!this.error) {
                            this.loaded++
                            this.countholder.innerHTML = this.loaded
                            localStorage.setItem(type + 's', JSON.stringify(res))

                            if (this.loaded == 2) {
                                this.status.innerHTML = ''
                                this.main.rmAttr('data-loading')
                                this.main.setAttr('data-loaded', '')
                                doc.location.href = 'create.html'
                            }
                        }
                    }

                    shops(res) { this.callback('shop', res) }
                    products(res) { this.callback('product', res) }
                }

                getListCallback = new getList()

                apiRequest('api/getShops', null, 'getListCallback.shops')
                apiRequest('api/getProducts', null, 'getListCallback.products')
            }
        </script>
    </body>
</html>