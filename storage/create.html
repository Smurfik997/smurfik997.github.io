<!DOCTYPE html>
<html lang="uk">
    <head>
        <meta charset="utf-8">
        <meta content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0,shrink-to-fit=no" name="viewport">
        <link rel="preload" crossorigin="anonymous" href="fonts/Comfortaa-Cyrillic-Bold.woff2" as="font">
        <link rel="preload" crossorigin="anonymous" href="fonts/Comfortaa-Cyrillic.woff2" as="font">
        <link rel="preload" crossorigin="anonymous" href="fonts/Comfortaa-Latin.woff2" as="font">
        <link rel="stylesheet" href="css/default.css">
        <link rel="icon" href="imgs/icon.png">
        <link rel="apple-touch-icon" href="imgs/apple-icon.png">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/create-page.css">
        <title>Purchase History - Редагування</title>
    </head>
    <body data-create-page>
        <header>
            <h1>Редагування чека</h1>
        </header>
        <main>
            <form id="create-form" name="create-form" onsubmit="submitForm(event)" autocomplete="off">
                <datalist id="shops"></datalist>
                <datalist id="products"></datalist>
                <input type="text" id="shopname" name="shopname" placeholder="Назва закладу" aria-label="Назва закладу" list="shops" required>
                <input type="date" id="date" name="date" aria-label="Дата" required>
                <table id="main-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Count</th>
                            <th>Units</th>
                            <th>Total Price</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr data-edit oninput="rowChange(this)" onfocusout="rmField(this)">
                            <td>
                                <input type="text" name="product" list="products" onfocus="editField(this)" 
                                placeholder="найменування товару" aria-label="найменування товару" required>
                            </td>
                            <td>
                                <input type="number" name="count" step="any" placeholder="кількість" aria-label="кількість" required>
                            </td>
                            <td>
                                <select name="type" aria-label="одиниці вимірювання">
                                    <option lang="en" selected>pcs</option>
                                    <option lang="en">kgs</option>
                                </select>
                            </td>
                            <td>
                                <input type="number" name="price" step="any" placeholder="вартість" aria-label="вартість" required>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="space_container"></div>
                <div class="submit_container">
                    <input type="submit" value="Зберегти"><!--
                    --><input type="button" onclick="doc.location.href = 'profile.html'" value="Скасувати">
                </div>
            </form>
        </main>
        <script src="scripts/main.js"></script>
        <script>
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent))
                document.body.setAttr('data-mobile', '')

            getElement('date').value = new Date().toISOString().substr(0, 10)
            getElement('date').max = new Date().toISOString().substr(0, 10)

            const types = ['shop', 'product']
            types.forEach(type => {
                const list = getElement(type + 's')
                const listData = JSON.parse(localStorage.getItem(type + 's'))

                if (!listData) doc.location.href = 'transfer.html'

                listData[type + 's'].forEach(val => {
                    list.innerHTML += `<option value="${val[`${type}-name`]}" data-id="${val.id}"></option>`
                })
            })

            const rowChange = (element) => {
                const inputCollection = getElement('input', 'byTagName', element)
                
                if (inputCollection[0].value && inputCollection[1].value && inputCollection[2].value)
                    if (!element.nextElementSibling) {
                        const currentElement = document.activeElement
                        const tr = addField()
                        const firstInNewRow = getElement('input', 'byTagName', tr)[0]
                        firstInNewRow.focus()
                        firstInNewRow.onfocus = () => editField(firstInNewRow)
                        currentElement.focus()
                    }
            }

            const editField = (element) => {
                const tr = element.parentNode.parentNode

                if (tr.getAttr('data-edit') == null) {
                    const prevEl = document.querySelector('form tr[data-edit]')
                    if (prevEl) prevEl.rmAttr('data-edit')
                    tr.setAttr('data-edit', '')
                    const inputCollection = getElement('input', 'byTagName', tr)
                    inputCollection[2].focus()
                    inputCollection[0].focus()
                }
            }

            const rmField = (element) => {
                const inputCollection = getElement('input', 'byTagName', element)
                
                if (!inputCollection[0].value && !inputCollection[1].value && !inputCollection[2].value)
                    if (element.nextElementSibling)
                        element.remove()
            }

            const addField = (element) => {
                let tr = document.createElement('tr')
                tr.innerHTML = `
                <td>
                    <input type="text" name="product" list="products" 
                    placeholder="найменування товару" aria-label="найменування товару">
                </td>
                <td>
                    <input type="number" name="count" step="any" placeholder="кількість" aria-label="кількість">
                </td>
                <td>
                    <select name="type" aria-label="одиниці вимірювання">
                        <option lang="en" selected>pcs</option>
                        <option lang="en">kgs</option>
                    </select>
                </td>
                <td>
                    <input type="number" name="price" step="any" placeholder="вартість" aria-label="вартість">
                </td>
                `
                tr.oninput = () => rowChange(tr)
                tr.addEventListener('focusout', () => rmField(tr))

                getElement('table-body').appendChild(tr)

                return tr
            }

            const submitForm = (e) => {
                e.preventDefault()
                const products = getElement('products')

                const form = doc.forms["create-form"]
                let data = []

                form["product"].forEach((el, index) => {
                    if (!el.value) return

                    data.push({
                        'product': el.value.trim(),
                        'count': form["count"][index].value,
                        'type': form["type"][index].value,
                        'price': form["price"][index].value.replace(',', '.')
                    })

                    if (id = products.querySelector(`option[value="${el.value}"]`))
                        data[data.length - 1]['product'] = id.getAttr('data-id')
                })

                let finalData = {
                    'shop-name': form["shopname"].value,
                    'date': form["date"].value,
                    'products': data
                }

                if (id = getElement('shops').querySelector(`option[value="${finalData['shop-name']}"]`))
                    finalData['shop-name'] = id.getAttr('data-id')

                localStorage.clear()
                localStorage.setItem('form-data', JSON.stringify(finalData))
                doc.location.href = 'transfer.html'
            }
        </script>
    </body>
</html>